<%- include('../partials/header', { user: user, title: title }) %>

<div class="container-fluid">
    <div class="row">
        <%- include('../partials/sidebar', { user: user }) %>
        
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-users me-2"></i>
                    User Management
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a href="/admin" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Back to Admin
                        </a>
                        <button class="btn btn-sm btn-primary" onclick="showCreateUserModal()">
                            <i class="fas fa-user-plus me-1"></i>
                            Add User
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        System Users
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>2FA</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (typeof users !== 'undefined' && users.length > 0) { %>
                                    <% users.forEach(function(userItem) { %>
                                    <tr>
                                        <td><%= userItem.id %></td>
                                        <td>
                                            <strong><%= userItem.name %></strong>
                                        </td>
                                        <td><%= userItem.email %></td>
                                        <td>
                                            <span class="badge bg-<%= userItem.role === 'admin' ? 'danger' : 'primary' %>">
                                                <%= userItem.role.toUpperCase() %>
                                            </span>
                                        </td>
                                        <td>
                                            <% if (userItem.two_fa_enabled) { %>
                                                <span class="badge bg-success">
                                                    <i class="fas fa-shield-alt me-1"></i>
                                                    Enabled
                                                </span>
                                            <% } else { %>
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-shield me-1"></i>
                                                    Disabled
                                                </span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (userItem.last_login) { %>
                                                <small class="text-muted">
                                                    <%= new Date(userItem.last_login).toLocaleDateString() %>
                                                </small>
                                            <% } else { %>
                                                <small class="text-muted">Never</small>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (userItem.is_active) { %>
                                                <span class="badge bg-success">Active</span>
                                            <% } else { %>
                                                <span class="badge bg-danger">Inactive</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <% if (userItem.two_fa_enabled) { %>
                                                    <button class="btn btn-sm btn-warning" 
                                                            onclick="disableTwoFA(<%= userItem.id %>)"
                                                            title="Disable 2FA">
                                                        <i class="fas fa-shield-alt"></i>
                                                    </button>
                                                <% } %>
                                                <button class="btn btn-sm btn-info" 
                                                        onclick="resetPassword(<%= userItem.id %>)"
                                                        title="Reset Password">
                                                    <i class="fas fa-key"></i>
                                                </button>
                                                <% if (userItem.id !== user.id) { %>
                                                    <button class="btn btn-sm btn-danger" 
                                                            onclick="deleteUser(<%= userItem.id %>, '<%= userItem.email %>')"
                                                            title="Delete User">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <i class="fas fa-users fa-2x text-muted mb-2"></i>
                                            <p class="text-muted">No users found in the system</p>
                                        </td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel">
                    <i class="fas fa-user-plus me-2"></i>
                    Create New User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label for="userName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="userRole" class="form-label">Role</label>
                        <select class="form-control" id="userRole" required>
                            <option value="user">User</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="userPassword" class="form-label">Temporary Password</label>
                        <input type="password" class="form-control" id="userPassword" required>
                        <div class="form-text">User will be prompted to change this on first login</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<script>
function showCreateUserModal() {
    new bootstrap.Modal(document.getElementById('createUserModal')).show();
}

function createUser() {
    // In a real implementation, this would send an AJAX request
    alert('User creation functionality would be implemented here. This would create a new user account with the specified details.');
}

function disableTwoFA(userId) {
    if (confirm('Are you sure you want to disable 2FA for this user?')) {
        fetch(`/admin/users/${userId}/disable-2fa`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('2FA has been disabled for the user');
                location.reload();
            } else {
                alert('Failed to disable 2FA: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
}

function resetPassword(userId) {
    if (confirm('Are you sure you want to reset this user\'s password? A temporary password will be generated.')) {
        fetch(`/admin/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Password has been reset. Temporary password: ${data.tempPassword}\n\nPlease share this with the user securely.`);
            } else {
                alert('Failed to reset password: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
}

function deleteUser(userId, userEmail) {
    if (confirm(`Are you sure you want to delete user "${userEmail}"? This action cannot be undone.`)) {
        fetch(`/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User has been deleted successfully');
                location.reload();
            } else {
                alert('Failed to delete user: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
}
</script>

<%- include('../partials/footer') %>