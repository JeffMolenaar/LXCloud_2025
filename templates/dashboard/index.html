{% extends "base.html" %}

{% block title %}Dashboard - LXCloud{% endblock %}

{% block extra_css %}
<style>
/* Modern Dashboard Styles */
.dashboard-container {
    min-height: calc(100vh - 120px);
    background: #f8f9fa;
    padding: 0;
}

.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.dashboard-header h1 {
    margin: 0;
    font-weight: 300;
    letter-spacing: -1px;
}

.dashboard-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}

.edit-mode-toggle {
    position: fixed;
    top: 80px;
    right: 30px;
    z-index: 1001;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 20px;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    transition: all 0.3s ease;
}

.edit-mode-toggle:hover {
    background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,123,255,0.4);
}

.edit-mode-toggle.active {
    background: #dc3545;
}

.edit-mode-toggle.active:hover {
    background: #c82333;
}

/* Grid System */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-auto-rows: 100px;
    gap: 1rem;
    padding: 2rem 2rem 2rem 2rem;
    max-width: 1600px;
    margin: 0 auto;
}

.grid-item {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 2px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.grid-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.grid-item.edit-mode {
    border-color: #007bff;
    cursor: move;
}

.grid-item.edit-mode::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,123,255,0.1);
    z-index: 1;
}

.grid-item.edit-mode .resize-handle {
    display: block;
}

.resize-handle {
    display: none;
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 15px;
    height: 15px;
    background: #007bff;
    cursor: nw-resize;
    border-radius: 3px;
    z-index: 2;
}

/* Card Sizes */
.card-small { grid-column: span 3; grid-row: span 2; }
.card-medium { grid-column: span 4; grid-row: span 3; }
.card-large { grid-column: span 6; grid-row: span 4; }
.card-xl { grid-column: span 8; grid-row: span 5; }
.card-full { grid-column: span 12; grid-row: span 4; }

/* Card Content */
.card-content {
    padding: 1.5rem;
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 0;
}

.stat-card .card-content {
    justify-content: center;
    text-align: center;
}

.stat-card .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    line-height: 1;
}

.stat-card .stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    margin: 0.5rem 0 0 0;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.stat-card .stat-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 2rem;
    opacity: 0.3;
}

/* Map Card */
.map-card #map {
    height: 100%;
    min-height: 300px;
    border-radius: 8px;
    border: 1px solid var(--border-light);
    background-color: var(--bg-primary);
}

.map-card .card-content {
    padding: 1rem;
}

/* Improve map visibility */
.leaflet-container {
    background: var(--bg-primary) !important;
}

.leaflet-control-zoom a {
    background-color: var(--bg-primary) !important;
    border: 1px solid var(--border-medium) !important;
    color: var(--text-primary) !important;
}

.leaflet-control-zoom a:hover {
    background-color: var(--primary-light) !important;
    color: var(--primary-color) !important;
}

.leaflet-control-attribution {
    background-color: rgba(255, 255, 255, 0.9) !important;
    color: var(--text-primary) !important;
    font-size: 11px !important;
}

/* Controller List Card */
.controller-list-card .controller-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f0f0f0;
}

.controller-list-card .controller-item:last-child {
    border-bottom: none;
}

.controller-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.status-online { background-color: #28a745; }
.status-offline { background-color: #dc3545; }

.controller-name {
    font-weight: 500;
    margin: 0;
    font-size: 0.9rem;
}

.controller-type {
    font-size: 0.8rem;
    color: #6c757d;
    margin: 0;
}

.controller-actions {
    margin-left: auto;
    display: flex;
    gap: 0.5rem;
}

.controller-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

/* Welcome Card */
.welcome-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.welcome-card .card-content {
    justify-content: center;
    text-align: center;
}

.welcome-card h3 {
    margin: 0;
    font-weight: 300;
}

.welcome-card p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: repeat(8, 1fr);
        padding: 0 1rem 2rem 1rem;
    }
    .card-large { grid-column: span 4; }
    .card-xl { grid-column: span 6; }
    .card-full { grid-column: span 8; }
}

@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
    }
    .card-small, .card-medium, .card-large, .card-xl { 
        grid-column: span 4; 
        grid-row: span 3;
    }
    .card-full { grid-column: span 4; grid-row: span 4; }
    
    .edit-mode-toggle {
        top: 80px;
        right: 15px;
        padding: 10px 16px;
    }
}

/* Drag and Drop Styles */
.grid-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.grid-item.drag-over {
    border-color: #28a745;
    background-color: rgba(40, 167, 69, 0.1);
}

/* Card Header */
.card-header-custom {
    display: flex;
    align-items: center;
    justify-content: between;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.card-header-custom h5 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #495057;
}

.card-header-custom .icon {
    margin-right: 0.5rem;
    color: #6c757d;
}

/* Card Management Panel */
.card-management-panel {
    position: fixed;
    top: 80px;
    right: 200px;
    width: 280px;
    background: white;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    z-index: 998;
    max-height: 70vh;
    overflow-y: auto;
}

.card-management-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border-light);
    background: var(--bg-secondary);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

.card-management-header h6 {
    margin: 0;
    font-weight: 600;
    color: var(--text-primary);
}

.btn-close-panel {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.btn-close-panel:hover {
    background: var(--danger-light);
    color: var(--danger-color);
}

.card-management-content {
    padding: 1rem;
}

.available-cards h6 {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
}

.card-option {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
}

.card-option input[type="checkbox"] {
    margin-right: 0.5rem;
    width: 16px;
    height: 16px;
}

.card-option label {
    font-size: 0.85rem;
    color: var(--text-primary);
    cursor: pointer;
    margin: 0;
}

.card-management-actions {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    gap: 0.5rem;
}

.card-management-actions .btn {
    flex: 1;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    

    <!-- Edit Mode Toggle -->
    <button class="edit-mode-toggle" id="editModeToggle" onclick="toggleEditMode()">
        <i class="fas fa-edit"></i> <span id="editModeText">Edit Layout</span>
    </button>
    
    <!-- Card Management Panel -->
    <div class="card-management-panel" id="cardManagementPanel" style="display: none;">
        <div class="card-management-header">
            <h6><i class="fas fa-th-large"></i> Card Management</h6>
            <button class="btn-close-panel" onclick="closeCardManagement()">×</button>
        </div>
        <div class="card-management-content">
            <div class="available-cards">
                <h6>Available Cards</h6>
                <div class="card-list">
                    <div class="card-option" data-card-id="welcome">
                        <input type="checkbox" id="card-welcome" checked onchange="toggleCard('welcome')">
                        <label for="card-welcome">Welcome Card</label>
                    </div>
                    <div class="card-option" data-card-id="total-controllers">
                        <input type="checkbox" id="card-total-controllers" checked onchange="toggleCard('total-controllers')">
                        <label for="card-total-controllers">Total Controllers</label>
                    </div>
                    <div class="card-option" data-card-id="online-controllers">
                        <input type="checkbox" id="card-online-controllers" checked onchange="toggleCard('online-controllers')">
                        <label for="card-online-controllers">Online Controllers</label>
                    </div>
                    <div class="card-option" data-card-id="offline-controllers">
                        <input type="checkbox" id="card-offline-controllers" checked onchange="toggleCard('offline-controllers')">
                        <label for="card-offline-controllers">Offline Controllers</label>
                    </div>
                    <div class="card-option" data-card-id="system-version">
                        <input type="checkbox" id="card-system-version" checked onchange="toggleCard('system-version')">
                        <label for="card-system-version">System Version</label>
                    </div>
                    <div class="card-option" data-card-id="map">
                        <input type="checkbox" id="card-map" checked onchange="toggleCard('map')">
                        <label for="card-map">Controller Map</label>
                    </div>
                    <div class="card-option" data-card-id="controller-list">
                        <input type="checkbox" id="card-controller-list" checked onchange="toggleCard('controller-list')">
                        <label for="card-controller-list">Controller List</label>
                    </div>
                    <div class="card-option" data-card-id="quick-actions">
                        <input type="checkbox" id="card-quick-actions" checked onchange="toggleCard('quick-actions')">
                        <label for="card-quick-actions">Quick Actions</label>
                    </div>
                    <div class="card-option" data-card-id="system-status">
                        <input type="checkbox" id="card-system-status" checked onchange="toggleCard('system-status')">
                        <label for="card-system-status">System Status</label>
                    </div>
                </div>
            </div>
            <div class="card-management-actions">
                <button class="btn btn-sm btn-secondary" onclick="resetLayout()">Reset Layout</button>
                <button class="btn btn-sm btn-primary" onclick="saveLayout()">Save Layout</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid" id="dashboardGrid">
        
        <!-- Welcome Card -->
        <div class="grid-item card-medium welcome-card" data-card-id="welcome">
            <div class="card-content">
                <h3>Welcome to LXCloud</h3>
                <p>Your modern IoT dashboard</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Total Controllers Card -->
        <div class="grid-item card-small stat-card" data-card-id="total-controllers">
            <div class="card-content">
                <i class="fas fa-microchip stat-icon"></i>
                <h2 class="stat-value text-primary">{{ total_controllers }}</h2>
                <p class="stat-label">Total Controllers</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Online Controllers Card -->
        <div class="grid-item card-small stat-card" data-card-id="online-controllers">
            <div class="card-content">
                <i class="fas fa-wifi stat-icon"></i>
                <h2 class="stat-value text-success">{{ online_controllers }}</h2>
                <p class="stat-label">Online</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Offline Controllers Card -->
        <div class="grid-item card-small stat-card" data-card-id="offline-controllers">
            <div class="card-content">
                <i class="fas fa-exclamation-triangle stat-icon"></i>
                <h2 class="stat-value text-warning">{{ total_controllers - online_controllers }}</h2>
                <p class="stat-label">Offline</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- System Version Card -->
        <div class="grid-item card-small stat-card" data-card-id="system-version">
            <div class="card-content">
                <i class="fas fa-code-branch stat-icon"></i>
                <h2 class="stat-value text-info">{{ version }}</h2>
                <p class="stat-label">Version</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Map Card -->
        <div class="grid-item card-large map-card" data-card-id="map">
            <div class="card-content">
                <div class="card-header-custom">
                    <h5>
                        <i class="fas fa-map-marked-alt icon"></i>
                        Controller Locations
                    </h5>
                </div>
                <div id="map"></div>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Controller List Card -->
        <div class="grid-item card-medium controller-list-card" data-card-id="controller-list">
            <div class="card-content">
                <div class="card-header-custom">
                    <h5>
                        <i class="fas fa-list icon"></i>
                        Recent Controllers
                    </h5>
                </div>
                <div class="controller-list">
                    {% if controllers %}
                        {% for controller in controllers[:8] %}
                        <div class="controller-item">
                            <span class="controller-status {{ 'status-online' if controller.is_online else 'status-offline' }}"></span>
                            <div class="controller-info">
                                <p class="controller-name">{{ controller.name or controller.serial_number }}</p>
                                <p class="controller-type">{{ controller.controller_type.title() }}</p>
                            </div>
                            <div class="controller-actions">
                                <a href="{{ url_for('controllers.view_data', controller_id=controller.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-chart-line"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if controllers|length > 8 %}
                        <div class="text-center mt-2">
                            <a href="{{ url_for('controllers.index') }}" class="btn btn-sm btn-outline-primary">
                                View All
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-microchip fa-2x text-muted mb-2"></i>
                            <p class="text-muted small">No Controllers</p>
                            <a href="{{ url_for('controllers.index') }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus"></i> Add Controller
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Quick Actions Card -->
        <div class="grid-item card-small" data-card-id="quick-actions">
            <div class="card-content">
                <div class="card-header-custom">
                    <h5>
                        <i class="fas fa-bolt icon"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('controllers.index') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus"></i> Add Controller
                    </a>
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('admin.index') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-cog"></i> Admin Panel
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- System Status Card -->
        <div class="grid-item card-small" data-card-id="system-status">
            <div class="card-content">
                <div class="card-header-custom">
                    <h5>
                        <i class="fas fa-heartbeat icon"></i>
                        System Status
                    </h5>
                </div>
                <div class="status-indicators">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small>Database</small>
                        <span class="badge bg-success">Online</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small>MQTT</small>
                        <span class="badge bg-warning">Connecting</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small>Web Server</small>
                        <span class="badge bg-success">Running</span>
                    </div>
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard state
let editMode = false;
let draggedElement = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Remove any duplicate cards first
    removeDuplicateCards();
    initializeDragAndDrop();
    loadLayoutFromStorage();
    // Initialize map after a short delay to ensure proper DOM rendering
    setTimeout(() => {
        initializeMap();
    }, 100);
});

// Remove duplicate cards that might be created during development
function removeDuplicateCards() {
    const cardIds = ['welcome', 'total-controllers', 'online-controllers', 'offline-controllers', 'system-version', 'map', 'controller-list', 'quick-actions', 'system-status'];
    
    cardIds.forEach(cardId => {
        const elements = document.querySelectorAll(`[data-card-id="${cardId}"].grid-item`);
        // Keep only the first element, remove the rest
        for (let i = 1; i < elements.length; i++) {
            elements[i].remove();
        }
    });
}

// Edit mode toggle
function toggleEditMode() {
    editMode = !editMode;
    const toggle = document.getElementById('editModeToggle');
    const text = document.getElementById('editModeText');
    const grid = document.getElementById('dashboardGrid');
    const panel = document.getElementById('cardManagementPanel');
    
    if (editMode) {
        toggle.classList.add('active');
        text.textContent = 'Exit Edit';
        grid.classList.add('edit-mode');
        panel.style.display = 'block';
        document.querySelectorAll('.grid-item').forEach(item => {
            item.classList.add('edit-mode');
        });
        updateCardCheckboxes();
    } else {
        toggle.classList.remove('active');
        text.textContent = 'Edit Layout';
        grid.classList.remove('edit-mode');
        panel.style.display = 'none';
        document.querySelectorAll('.grid-item').forEach(item => {
            item.classList.remove('edit-mode');
        });
        // Don't reload layout here since we save immediately on changes
    }
}

// Card Management Functions
function toggleCard(cardId) {
    const cards = document.querySelectorAll(`[data-card-id="${cardId}"]`);
    const checkbox = document.getElementById(`card-${cardId}`);
    
    if (cards.length > 0 && checkbox) {
        cards.forEach(card => {
            if (checkbox.checked) {
                card.style.display = '';
                console.log(`Showing card: ${cardId}`);
            } else {
                card.style.display = 'none';
                console.log(`Hiding card: ${cardId}`);
            }
        });
        // Save layout immediately when card visibility changes
        saveLayoutToStorage();
    }
}

function updateCardCheckboxes() {
    document.querySelectorAll('.grid-item').forEach(item => {
        const cardId = item.dataset.cardId;
        const checkbox = document.getElementById(`card-${cardId}`);
        if (checkbox) {
            checkbox.checked = item.style.display !== 'none';
        }
    });
}

function closeCardManagement() {
    if (editMode) {
        toggleEditMode();
    }
}

function saveLayout() {
    saveLayoutToStorage();
    flash('Layout saved successfully!', 'success');
}

function flash(message, type) {
    // Create a simple flash message
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '100px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 3000);
}

// Initialize drag and drop
function initializeDragAndDrop() {
    const gridItems = document.querySelectorAll('.grid-item');
    
    gridItems.forEach(item => {
        // Make items draggable
        item.draggable = true;
        
        // Drag start
        item.addEventListener('dragstart', function(e) {
            if (!editMode) {
                e.preventDefault();
                return;
            }
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        });
        
        // Drag end
        item.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
            draggedElement = null;
        });
        
        // Drag over
        item.addEventListener('dragover', function(e) {
            if (!editMode || !draggedElement) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        });
        
        // Drag leave
        item.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });
        
        // Drop
        item.addEventListener('drop', function(e) {
            if (!editMode || !draggedElement) return;
            e.preventDefault();
            this.classList.remove('drag-over');
            
            // Swap elements
            if (this !== draggedElement) {
                const parent = this.parentNode;
                const draggedNext = draggedElement.nextSibling;
                const thisNext = this.nextSibling;
                
                parent.insertBefore(draggedElement, thisNext);
                parent.insertBefore(this, draggedNext);
                
                // Save layout after position change
                saveLayoutToStorage();
                
                // If map was moved, reinitialize it
                if (draggedElement.dataset.cardId === 'map' || this.dataset.cardId === 'map') {
                    setTimeout(() => {
                        initializeMap();
                    }, 100);
                }
            }
        });
        
        // Resize functionality
        const resizeHandle = item.querySelector('.resize-handle');
        if (resizeHandle) {
            resizeHandle.addEventListener('mousedown', function(e) {
                if (!editMode) return;
                e.preventDefault();
                e.stopPropagation();
                
                const startX = e.clientX;
                const startY = e.clientY;
                const startRect = item.getBoundingClientRect();
                
                function onMouseMove(e) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    // Calculate new size based on grid
                    const gridSize = 100; // Grid row height
                    const newCols = Math.max(3, Math.round((startRect.width + deltaX) / (startRect.width / getCurrentCols(item))));
                    const newRows = Math.max(2, Math.round((startRect.height + deltaY) / gridSize));
                    
                    // Update CSS grid properties
                    item.style.gridColumn = `span ${Math.min(newCols, 12)}`;
                    item.style.gridRow = `span ${newRows}`;
                    
                    // If this is a map card, trigger map resize
                    if (item.dataset.cardId === 'map') {
                        debounceMapResize();
                    }
                }
                
                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    saveLayoutToStorage();
                    
                    // Final map resize for map cards
                    if (item.dataset.cardId === 'map') {
                        setTimeout(() => {
                            resizeMap();
                        }, 100);
                    }
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }
    });
}

// Get current column span of an element
function getCurrentCols(element) {
    const computedStyle = window.getComputedStyle(element);
    const gridColumn = computedStyle.gridColumn;
    const match = gridColumn.match(/span (\d+)/);
    return match ? parseInt(match[1]) : 3;
}

// Map resizing utilities
let mapResizeTimeout;
let currentMap = null;

function debounceMapResize() {
    clearTimeout(mapResizeTimeout);
    mapResizeTimeout = setTimeout(resizeMap, 100);
}

function resizeMap() {
    if (currentMap) {
        try {
            currentMap.invalidateSize();
            console.log('Map resized');
        } catch (error) {
            console.warn('Error resizing map:', error);
        }
    }
}

// Save layout to localStorage
function saveLayoutToStorage() {
    const layout = [];
    document.querySelectorAll('.grid-item').forEach((item, index) => {
        const cardId = item.dataset.cardId;
        const style = window.getComputedStyle(item);
        const isVisible = item.style.display !== 'none';
        layout.push({
            cardId: cardId,
            order: index,
            gridColumn: item.style.gridColumn || style.gridColumn,
            gridRow: item.style.gridRow || style.gridRow,
            visible: isVisible
        });
    });
    console.log('Saving layout:', layout);
    localStorage.setItem('dashboardLayout', JSON.stringify(layout));
}

// Load layout from localStorage
function loadLayoutFromStorage() {
    const saved = localStorage.getItem('dashboardLayout');
    if (!saved) {
        console.log('No saved layout found');
        return;
    }
    
    try {
        const layout = JSON.parse(saved);
        console.log('Loading layout:', layout);
        
        // Sort layout by order to restore positioning
        layout.sort((a, b) => a.order - b.order);
        
        const grid = document.getElementById('dashboardGrid');
        const gridItems = Array.from(document.querySelectorAll('.grid-item'));
        
        // Create a map of current elements by cardId
        const elementMap = new Map();
        gridItems.forEach(element => {
            const cardId = element.dataset.cardId;
            if (cardId) {
                elementMap.set(cardId, element);
            }
        });
        
        // Reorder elements according to saved layout
        layout.forEach((item, index) => {
            const element = elementMap.get(item.cardId);
            if (element) {
                // Remove element from current position
                element.remove();
                
                // Apply sizing
                if (item.gridColumn && item.gridColumn !== 'auto') {
                    element.style.gridColumn = item.gridColumn;
                }
                if (item.gridRow && item.gridRow !== 'auto') {
                    element.style.gridRow = item.gridRow;
                }
                
                // Apply visibility
                if (item.visible === false || item.visible === 'false') {
                    element.style.display = 'none';
                    console.log(`Hiding card on load: ${item.cardId}`);
                } else {
                    element.style.display = '';
                    console.log(`Showing card on load: ${item.cardId}`);
                }
                
                // Re-append element to restore order
                grid.appendChild(element);
            }
        });
        
        // Update checkboxes if in edit mode
        if (editMode) {
            updateCardCheckboxes();
        }
        
        // Re-initialize map after layout changes
        setTimeout(() => {
            initializeMap();
        }, 200);
        
    } catch (e) {
        console.warn('Failed to load dashboard layout:', e);
        localStorage.removeItem('dashboardLayout'); // Clear corrupt data
    }
}

// Initialize map
function initializeMap() {
    const mapElement = document.getElementById('map');
    if (!mapElement) {
        console.log('Map element not found');
        return;
    }
    
    // Check if the map card is visible
    const mapCard = mapElement.closest('.grid-item');
    if (mapCard && mapCard.style.display === 'none') {
        console.log('Map card is hidden, skipping initialization');
        return;
    }
    
    // Clear any existing content and show loading
    mapElement.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Loading map...</div>';
    
    try {
        // Clear any existing content and show loading
        mapElement.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Loading map...</div>';
        
        const map = L.map('map').setView([52.3676, 4.9041], 8); // Default to Netherlands
        currentMap = map; // Store reference for resizing

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Custom markers for different controller types
        const markerIcons = {
            speedradar: L.divIcon({
                html: '<i class="fas fa-tachometer-alt"></i>',
                iconSize: [30, 30],
                className: 'custom-div-icon custom-marker-speedradar'
            }),
            beaufortmeter: L.divIcon({
                html: '<i class="fas fa-wind"></i>',
                iconSize: [30, 30],
                className: 'custom-div-icon custom-marker-beaufortmeter'
            }),
            weatherstation: L.divIcon({
                html: '<i class="fas fa-cloud-sun"></i>',
                iconSize: [30, 30],
                className: 'custom-div-icon custom-marker-weatherstation'
            }),
            aicamera: L.divIcon({
                html: '<i class="fas fa-camera"></i>',
                iconSize: [30, 30],
                className: 'custom-div-icon custom-marker-aicamera'
            }),
            default: L.divIcon({
                html: '<i class="fas fa-microchip"></i>',
                iconSize: [30, 30],
                className: 'custom-div-icon custom-marker-default'
            })
        };

        // Load controller data and add markers
        fetch('/map-data')
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const group = new L.featureGroup();
                
                data.forEach(controller => {
                    const icon = markerIcons[controller.type] || markerIcons.default;
                    const statusClass = controller.is_online ? 'online' : 'offline';
                    
                    const marker = L.marker([controller.latitude, controller.longitude], {
                        icon: icon
                    }).addTo(map);
                    
                    // Add marker to group for auto-fitting bounds
                    group.addLayer(marker);
                    
                    // Create popup content
                    const popupContent = `
                        <div class="marker-popup">
                            <h6>${controller.name}</h6>
                            <p class="mb-1">
                                <span class="controller-status status-${statusClass}"></span>
                                ${controller.is_online ? 'Online' : 'Offline'}
                            </p>
                            <p class="mb-1"><strong>Type:</strong> ${controller.type.charAt(0).toUpperCase() + controller.type.slice(1)}</p>
                            <p class="mb-1"><strong>Serial:</strong> ${controller.serial_number}</p>
                            ${controller.last_seen ? `<p class="mb-2"><strong>Last Seen:</strong> ${new Date(controller.last_seen).toLocaleString()}</p>` : ''}
                            <div class="text-center">
                                <a href="/controllers/${controller.id}/data" class="btn btn-sm btn-primary">
                                    <i class="fas fa-chart-line"></i> View Data
                                </a>
                                <a href="/controllers/${controller.id}/edit" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                            </div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                });
                
                // Fit map to show all markers
                if (group.getLayers().length > 0) {
                    map.fitBounds(group.getBounds().pad(0.1));
                } else {
                    // No markers, show a default message
                    mapElement.innerHTML = '<div class="text-center p-4 text-muted"><i class="fas fa-map-marker-alt"></i><br>No controllers with location data</div>';
                }
                
                // Trigger initial resize to ensure map renders correctly
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        })
        .catch(error => {
            console.error('Error loading map data:', error);
            mapElement.innerHTML = '<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle"></i><br>Error loading map data</div>';
        });

        // Auto-refresh dashboard data every 30 seconds
        setInterval(() => {
            // Update statistics if needed
            fetch('/api/stats/overview')
                .then(response => response.json())
                .then(data => {
                    // Update statistics
                    updateStatistics(data);
                })
                .catch(error => console.error('Error updating stats:', error));
        }, 30000);
        
    } catch (error) {
        console.error('Error initializing map:', error);
        mapElement.innerHTML = '<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle"></i><br>Failed to initialize map</div>';
    }
}

// Update statistics
function updateStatistics(data) {
    // Update stat cards with new data
    if (data.total_controllers !== undefined) {
        const totalCard = document.querySelector('[data-card-id="total-controllers"] .stat-value');
        if (totalCard) totalCard.textContent = data.total_controllers;
    }
    
    if (data.online_controllers !== undefined) {
        const onlineCard = document.querySelector('[data-card-id="online-controllers"] .stat-value');
        if (onlineCard) onlineCard.textContent = data.online_controllers;
        
        const offlineCard = document.querySelector('[data-card-id="offline-controllers"] .stat-value');
        if (offlineCard) offlineCard.textContent = data.total_controllers - data.online_controllers;
    }
}

// Reset layout to default
function resetLayout() {
    localStorage.removeItem('dashboardLayout');
    location.reload();
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + E to toggle edit mode
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        toggleEditMode();
    }
    
    // Escape to exit edit mode
    if (e.key === 'Escape' && editMode) {
        toggleEditMode();
    }
});
</script>

<style>
.custom-div-icon {
    background: #007bff;
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 30px;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.custom-marker-speedradar { background: #17a2b8; }
.custom-marker-beaufortmeter { background: #28a745; }
.custom-marker-weatherstation { background: #ffc107; color: #000; }
.custom-marker-aicamera { background: #dc3545; }

.marker-popup {
    min-width: 200px;
}

.marker-popup .controller-status {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 5px;
}

.marker-popup .status-online {
    background-color: #28a745;
}

.marker-popup .status-offline {
    background-color: #dc3545;
}
</style>
{% endblock %}
