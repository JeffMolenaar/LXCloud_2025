{% extends "base.html" %}

{% block title %}Dashboard - LXCloud{% endblock %}

{% block extra_css %}
<style>
.dashboard-card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.dashboard-card:hover {
    transform: translateY(-2px);
}

.stat-icon {
    font-size: 2.5rem;
    opacity: 0.7;
}

#map {
    height: 500px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.controller-status {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
}

.status-online {
    background-color: #28a745;
}

.status-offline {
    background-color: #dc3545;
}

.controller-card {
    border-left: 4px solid #007bff;
}

.controller-card.online {
    border-left-color: #28a745;
}

.controller-card.offline {
    border-left-color: #dc3545;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-tachometer-alt text-primary"></i> 
                Dashboard
            </h1>
            <p class="text-muted">Welcome back, {{ current_user.full_name or current_user.username }}!</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card dashboard-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title mb-0">{{ total_controllers }}</h4>
                            <p class="card-text">Total Controllers</p>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-microchip"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title mb-0">{{ online_controllers }}</h4>
                            <p class="card-text">Online</p>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-wifi"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title mb-0">{{ total_controllers - online_controllers }}</h4>
                            <p class="card-text">Offline</p>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title mb-0">{{ version }}</h4>
                            <p class="card-text">System Version</p>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-code-branch"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Map View -->
        <div class="col-lg-8">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map-marked-alt"></i> 
                        Controller Locations
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- Controller List -->
        <div class="col-lg-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> 
                        Recent Controllers
                    </h5>
                </div>
                <div class="card-body">
                    {% if controllers %}
                        <div class="list-group list-group-flush">
                            {% for controller in controllers[:10] %}
                            <div class="list-group-item border-0 px-0 controller-card {{ 'online' if controller.is_online else 'offline' }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            <span class="controller-status {{ 'status-online' if controller.is_online else 'status-offline' }}"></span>
                                            {{ controller.name or controller.serial_number }}
                                        </h6>
                                        <small class="text-muted">
                                            {{ controller.controller_type.title() }} • {{ controller.serial_number }}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">
                                            {% if controller.last_seen %}
                                                {{ controller.last_seen.strftime('%H:%M') }}
                                            {% else %}
                                                Never
                                            {% endif %}
                                        </small>
                                        <br>
                                        <a href="{{ url_for('controllers.view_data', controller_id=controller.id) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-chart-line"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if controllers|length > 10 %}
                        <div class="text-center mt-3">
                            <a href="{{ url_for('controllers.index') }}" class="btn btn-outline-primary">
                                View All Controllers
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-microchip fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No Controllers</h6>
                            <p class="text-muted small">Bind your first controller to get started</p>
                            <a href="{{ url_for('controllers.index') }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Controller
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize map
const map = L.map('map').setView([52.3676, 4.9041], 8); // Default to Netherlands

// Add tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

// Custom markers for different controller types
const markerIcons = {
    speedradar: L.divIcon({
        html: '<i class="fas fa-tachometer-alt"></i>',
        iconSize: [30, 30],
        className: 'custom-div-icon custom-marker-speedradar'
    }),
    beaufortmeter: L.divIcon({
        html: '<i class="fas fa-wind"></i>',
        iconSize: [30, 30],
        className: 'custom-div-icon custom-marker-beaufortmeter'
    }),
    weatherstation: L.divIcon({
        html: '<i class="fas fa-cloud-sun"></i>',
        iconSize: [30, 30],
        className: 'custom-div-icon custom-marker-weatherstation'
    }),
    aicamera: L.divIcon({
        html: '<i class="fas fa-camera"></i>',
        iconSize: [30, 30],
        className: 'custom-div-icon custom-marker-aicamera'
    }),
    default: L.divIcon({
        html: '<i class="fas fa-microchip"></i>',
        iconSize: [30, 30],
        className: 'custom-div-icon custom-marker-default'
    })
};

// Load controller data and add markers
fetch('/map-data')
    .then(response => response.json())
    .then(data => {
        if (data.length > 0) {
            const group = new L.featureGroup();
            
            data.forEach(controller => {
                const icon = markerIcons[controller.type] || markerIcons.default;
                const statusClass = controller.is_online ? 'online' : 'offline';
                
                const marker = L.marker([controller.latitude, controller.longitude], {
                    icon: icon
                }).addTo(map);
                
                // Add marker to group for auto-fitting bounds
                group.addLayer(marker);
                
                // Create popup content
                const popupContent = `
                    <div class="marker-popup">
                        <h6>${controller.name}</h6>
                        <p class="mb-1">
                            <span class="controller-status status-${statusClass}"></span>
                            ${controller.is_online ? 'Online' : 'Offline'}
                        </p>
                        <p class="mb-1"><strong>Type:</strong> ${controller.type.charAt(0).toUpperCase() + controller.type.slice(1)}</p>
                        <p class="mb-1"><strong>Serial:</strong> ${controller.serial_number}</p>
                        ${controller.last_seen ? `<p class="mb-2"><strong>Last Seen:</strong> ${new Date(controller.last_seen).toLocaleString()}</p>` : ''}
                        <div class="text-center">
                            <a href="/controllers/${controller.id}/data" class="btn btn-sm btn-primary">
                                <i class="fas fa-chart-line"></i> View Data
                            </a>
                            <a href="/controllers/${controller.id}/edit" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
            });
            
            // Fit map to show all markers
            map.fitBounds(group.getBounds().pad(0.1));
        }
    })
    .catch(error => {
        console.error('Error loading map data:', error);
    });

// Auto-refresh dashboard data every 30 seconds
setInterval(() => {
    // You can add real-time updates here
    fetch('/api/stats/overview')
        .then(response => response.json())
        .then(data => {
            // Update statistics if needed
        })
        .catch(error => console.error('Error updating stats:', error));
}, 30000);
</script>

<style>
.custom-div-icon {
    background: #007bff;
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 30px;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.custom-marker-speedradar { background: #17a2b8; }
.custom-marker-beaufortmeter { background: #28a745; }
.custom-marker-weatherstation { background: #ffc107; color: #000; }
.custom-marker-aicamera { background: #dc3545; }

.marker-popup {
    min-width: 200px;
}

.marker-popup .controller-status {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 5px;
}

.marker-popup .status-online {
    background-color: #28a745;
}

.marker-popup .status-offline {
    background-color: #dc3545;
}
</style>
{% endblock %}