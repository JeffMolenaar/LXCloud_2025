{% extends "base.html" %}

{% block title %}Dashboard - LXCloud{% endblock %}

{% block extra_css %}
<style>
    /* Modern Dashboard Styles */
    .dashboard-container { min-height: calc(100vh - 120px); background: #f8f9fa; padding: 0; }

    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white; padding: 2rem 0; margin-bottom: 2rem;
    }
    .dashboard-header h1 { margin: 0; font-weight: 300; letter-spacing: -1px; }
    .dashboard-header p { margin: 0.5rem 0 0 0; opacity: 0.9; }

    .edit-mode-toggle {
        position: fixed; top: 80px; right: 30px; z-index: 1001;
        background: #007bff; color: white; border: none; border-radius: 50px;
        padding: 12px 20px; box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        transition: all 0.3s ease;
    }
    .edit-mode-toggle:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,123,255,0.4); }
    .edit-mode-toggle.active { background: #dc3545; }
    .edit-mode-toggle.active:hover { background: #c82333; }

    /* Grid System */
    .dashboard-grid {
        display: grid; grid-template-columns: repeat(12, 1fr); grid-auto-rows: 100px;
        gap: 1rem; padding: 2rem; max-width: 1600px; margin: 0 auto;
    }

    .grid-item {
        background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 2px solid transparent; transition: all 0.3s ease; position: relative; overflow: hidden;
    }
    .grid-item:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
    .grid-item.edit-mode { border-color: #007bff; cursor: move; }
    .grid-item.edit-mode::before { content: ''; position: absolute; inset: 0; background: rgba(0,123,255,0.1); z-index: 1; }
    .grid-item.edit-mode .resize-handle { display: block; }

    .resize-handle {
        display: none; position: absolute; bottom: 5px; right: 5px; width: 15px; height: 15px;
        background: #007bff; cursor: nw-resize; border-radius: 3px; z-index: 2;
    }

    /* Card Sizes */
    .card-small { grid-column: span 3; grid-row: span 2; }
    .card-medium { grid-column: span 4; grid-row: span 3; }
    .card-large { grid-column: span 6; grid-row: span 4; }
    .card-xl { grid-column: span 8; grid-row: span 5; }
    .card-full { grid-column: span 12; grid-row: span 4; }

    /* Card Content */
    .card-content { padding: 1.5rem; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 0; }

    .stat-card .card-content { justify-content: center; text-align: center; }
    .stat-card .stat-value { font-size: 2.5rem; font-weight: 700; margin: 0; line-height: 1; }
    .stat-card .stat-label { font-size: 0.9rem; color: #6c757d; margin: 0.5rem 0 0 0; text-transform: uppercase; letter-spacing: 1px; }
    .stat-card .stat-icon { position: absolute; top: 1rem; right: 1rem; font-size: 2rem; opacity: 0.3; }

    /* Map Card */
    .map-card #map {
        height: 100%; min-height: 300px; border-radius: 8px; border: 1px solid var(--border-light);
        background-color: var(--bg-primary); position: relative; /* overlay anchor */
    }
    .map-card .card-content { padding: 1rem; }

    /* IMPORTANT: disable hover transform on the map card to avoid pointer math issues */
    .map-card.grid-item:hover { transform: none; box-shadow: 0 4px 16px rgba(0,0,0,0.15); }

    /* OpenLayers popup */
    .ol-popup {
        position: absolute; background: #fff; padding: 10px 12px; border: 1px solid #e5e7eb;
        border-radius: 6px; min-width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,.12);
        transform: translate(-50%, -100%); /* anchor above */
    }
    .ol-popup:after, .ol-popup:before {
        top: 100%; border: solid transparent; content: " "; height: 0; width: 0; position: absolute; pointer-events: none;
    }
    .ol-popup:after { border-top-color: #fff; border-width: 10px; left: 50%; margin-left: -10px; }
    .ol-popup:before { border-top-color: #e5e7eb; border-width: 11px; left: 50%; margin-left: -11px; }

    /* Controller List Card */
    .controller-list-card .controller-item { display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0; }
    .controller-list-card .controller-item:last-child { border-bottom: none; }

    .controller-status { width: 8px; height: 8px; border-radius: 50%; margin-right: 0.75rem; flex-shrink: 0; }
    .status-online { background-color: #28a745; }
    .status-offline { background-color: #dc3545; }

    .controller-name { font-weight: 500; margin: 0; font-size: 0.9rem; }
    .controller-type { font-size: 0.8rem; color: #6c757d; margin: 0; }
    .controller-actions { margin-left: auto; display: flex; gap: 0.5rem; }
    .controller-actions .btn { padding: 0.25rem 0.5rem; font-size: 0.8rem; }

    /* Welcome Card */
    .welcome-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .welcome-card .card-content { justify-content: center; text-align: center; }
    .welcome-card h3 { margin: 0; font-weight: 300; }
    .welcome-card p { margin: 0.5rem 0 0 0; opacity: 0.9; }

    /* Responsive */
    @media (max-width: 1200px) {
        .dashboard-grid { grid-template-columns: repeat(8, 1fr); padding: 0 1rem 2rem 1rem; }
        .card-large { grid-column: span 4; }
        .card-xl { grid-column: span 6; }
        .card-full { grid-column: span 8; }
    }
    @media (max-width: 768px) {
        .dashboard-grid { grid-template-columns: repeat(4, 1fr); gap: 0.75rem; }
        .card-small, .card-medium, .card-large, .card-xl { grid-column: span 4; grid-row: span 3; }
        .card-full { grid-column: span 4; grid-row: span 4; }
        .edit-mode-toggle { top: 80px; right: 15px; padding: 10px 16px; }
    }

    /* Drag/Drop */
    .grid-item.dragging { opacity: 0.5; transform: rotate(5deg); }
    .grid-item.drag-over { border-color: #28a745; background-color: rgba(40,167,69,0.1); }

    /* Card Header */
    .card-header-custom { display: flex; align-items: center; justify-content: between; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e9ecef; }
    .card-header-custom h5 { margin: 0; font-size: 1rem; font-weight: 600; color: #495057; }
    .card-header-custom .icon { margin-right: 0.5rem; color: #6c757d; }

    /* Card Management Panel */
    .card-management-panel {
        position: fixed; top: 80px; right: 200px; width: 280px; background: white; border: 1px solid var(--border-light);
        border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); z-index: 998; max-height: 70vh; overflow-y: auto;
    }
    .card-management-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-light); background: var(--bg-secondary); border-radius: var(--radius-xl) var(--radius-xl) 0 0; }
    .card-management-header h6 { margin: 0; font-weight: 600; color: var(--text-primary); }

    .btn-close-panel { background: none; border: none; font-size: 1.2rem; color: var(--text-secondary); cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .btn-close-panel:hover { background: var(--danger-light); color: var(--danger-color); }

    .card-management-content { padding: 1rem; }
    .available-cards h6 { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary); }
    .card-option { display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.25rem 0; }
    .card-option input[type="checkbox"] { margin-right: 0.5rem; width: 16px; height: 16px; }
    .card-option label { font-size: 0.85rem; color: var(--text-primary); cursor: pointer; margin: 0; }

    .card-management-actions { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-light); display: flex; gap: 0.5rem; }
    .card-management-actions .btn { flex: 1; font-size: 0.8rem; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- Edit Mode Toggle -->
    <button class="edit-mode-toggle" id="editModeToggle" onclick="toggleEditMode()">
        <i class="fas fa-edit"></i> <span id="editModeText">Edit Layout</span>
    </button>

    <!-- Card Management Panel -->
    <div class="card-management-panel" id="cardManagementPanel" style="display: none;">
        <div class="card-management-header">
            <h6><i class="fas fa-th-large"></i> Card Management</h6>
            <button class="btn-close-panel" onclick="closeCardManagement()">×</button>
        </div>
        <div class="card-management-content">
            <div class="available-cards">
                <h6>Available Cards</h6>
                <div class="card-list">
                    <div class="card-option" data-card-id="welcome">
                        <input type="checkbox" id="card-welcome" checked onchange="toggleCard('welcome')">
                        <label for="card-welcome">Welcome Card</label>
                    </div>
                    <div class="card-option" data-card-id="total-controllers">
                        <input type="checkbox" id="card-total-controllers" checked onchange="toggleCard('total-controllers')">
                        <label for="card-total-controllers">Total Controllers</label>
                    </div>
                    <div class="card-option" data-card-id="online-controllers">
                        <input type="checkbox" id="card-online-controllers" checked onchange="toggleCard('online-controllers')">
                        <label for="card-online-controllers">Online Controllers</label>
                    </div>
                    <div class="card-option" data-card-id="offline-controllers">
                        <input type="checkbox" id="card-offline-controllers" checked onchange="toggleCard('offline-controllers')">
                        <label for="card-offline-controllers">Offline Controllers</label>
                    </div>
                    <div class="card-option" data-card-id="system-version">
                        <input type="checkbox" id="card-system-version" checked onchange="toggleCard('system-version')">
                        <label for="card-system-version">System Version</label>
                    </div>
                    <div class="card-option" data-card-id="map">
                        <input type="checkbox" id="card-map" checked onchange="toggleCard('map')">
                        <label for="card-map">Controller Map</label>
                    </div>
                    <div class="card-option" data-card-id="controller-list">
                        <input type="checkbox" id="card-controller-list" checked onchange="toggleCard('controller-list')">
                        <label for="card-controller-list">Controller List</label>
                    </div>
                    <div class="card-option" data-card-id="quick-actions">
                        <input type="checkbox" id="card-quick-actions" checked onchange="toggleCard('quick-actions')">
                        <label for="card-quick-actions">Quick Actions</label>
                    </div>
                    <div class="card-option" data-card-id="system-status">
                        <input type="checkbox" id="card-system-status" checked onchange="toggleCard('system-status')">
                        <label for="card-system-status">System Status</label>
                    </div>
                </div>
            </div>
            <div class="card-management-actions">
                <button class="btn btn-sm btn-secondary" onclick="resetLayout()">Reset Layout</button>
                <button class="btn btn-sm btn-primary" onclick="saveLayout()">Save Layout</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid" id="dashboardGrid">

        <!-- Welcome Card -->
        <div class="grid-item card-medium welcome-card" data-card-id="welcome">
            <div class="card-content">
                <h3>Welcome to LXCloud</h3>
                <p>Your modern IoT dashboard</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Total Controllers Card -->
        <div class="grid-item card-small stat-card" data-card-id="total-controllers">
            <div class="card-content">
                <h2 class="stat-value text-primary">{{ total_controllers }}</h2>
                <p class="stat-label">Total Controllers</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Online Controllers Card -->
        <div class="grid-item card-small stat-card" data-card-id="online-controllers">
            <div class="card-content">
                <i class="fas fa-wifi stat-icon"></i>
                <h2 class="stat-value text-success">{{ online_controllers }}</h2>
                <p class="stat-label">Online</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Offline Controllers Card -->
        <div class="grid-item card-small stat-card" data-card-id="offline-controllers">
            <div class="card-content">
                <h2 class="stat-value text-warning">{{ total_controllers - online_controllers }}</h2>
                <p class="stat-label">Offline</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- System Version Card -->
        <div class="grid-item card-small stat-card" data-card-id="system-version">
            <div class="card-content">
                <i class="fas fa-code-branch stat-icon"></i>
                <h2 class="stat-value text-info">{{ version }}</h2>
                <p class="stat-label">Version</p>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Map Card -->
        <div class="grid-item card-large map-card" data-card-id="map">
            <div class="card-content">
                <div class="card-header-custom">
                    <h5><i class="fas fa-map-marked-alt icon"></i> Controller Locations</h5>
                </div>
                <div id="map"></div>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Controller List Card -->
        <div class="grid-item card-medium controller-list-card" data-card-id="controller-list">
            <div class="card-content">
                <div class="card-header-custom">
                    <h5><i class="fas fa-list icon"></i> Recent Controllers</h5>
                </div>
                <div class="controller-list">
                    {% if controllers %}
                    {% for controller in controllers[:8] %}
                    <div class="controller-item">
                        <span class="controller-status {{ 'status-online' if controller.is_online else 'status-offline' }}"></span>
                        <div class="controller-info">
                            <p class="controller-name">{{ controller.name or controller.serial_number }}</p>
                            <p class="controller-type">{{ controller.controller_type.title() }}</p>
                        </div>
                        <div class="controller-actions">
                            <a href="{{ url_for('controllers.view_data', controller_id=controller.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-chart-line"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                    {% if controllers|length > 8 %}
                    <div class="text-center mt-2">
                        <a href="{{ url_for('controllers.index') }}" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-microchip fa-2x text-muted mb-2"></i>
                        <p class="text-muted small">No Controllers</p>
                        <a href="{{ url_for('controllers.index') }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> Add Controller
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- Quick Actions Card -->
        <div class="grid-item card-small" data-card-id="quick-actions">
            <div class="card-content">
                <div class="card-header-custom">
                    <h5><i class="fas fa-bolt icon"></i> Quick Actions</h5>
                </div>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('controllers.index') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus"></i> Add Controller
                    </a>
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('admin.index') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-cog"></i> Admin Panel
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- System Status Card -->
        <div class="grid-item card-small" data-card-id="system-status">
            <div class="card-content">
                <div class="card-header-custom">
                    <h5><i class="fas fa-heartbeat icon"></i> System Status</h5>
                </div>
                <div class="status-indicators">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small>Database</small><span class="badge bg-success">Online</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small>MQTT</small><span class="badge bg-warning">Connecting</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small>Web Server</small><span class="badge bg-success">Running</span>
                    </div>
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* --------- Dynamically load OpenLayers (JS + CSS) ---------- */
function ensureOpenLayers() {
  return new Promise((resolve, reject) => {
    if (window.ol && typeof ol.Map === 'function') return resolve();
    if (window.__olLoading) {
      const iv = setInterval(() => {
        if (window.ol && typeof ol.Map === 'function') { clearInterval(iv); resolve(); }
      }, 50);
      return;
    }
    window.__olLoading = true;

    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/ol@latest/ol.css';
    document.head.appendChild(link);

    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js';
    script.onload = () => resolve();
    script.onerror = () => reject(new Error('Failed to load OpenLayers'));
    document.body.appendChild(script);
  });
}
/* ---------------------------------------------------------- */
</script>

<script>
/* ======= Dashboard state ======= */
let editMode = false;
let draggedElement = null;

/* ======= Map state (OpenLayers) ======= */
let olMap = null;
let vectorSource = null;
let vectorLayer = null;
let popupOverlay = null;
const featuresById = {};  // id -> ol.Feature
const REFRESH_MS = 10000;
let mapStatusEl = null;

document.addEventListener('DOMContentLoaded', async function () {
    removeDuplicateCards();
    initializeDragAndDrop();
    loadLayoutFromStorage();

    try { await ensureOpenLayers(); }
    catch (e) { console.error(e); setMapStatus('Map library failed to load.', 'error'); return; }

    setTimeout(initializeMap, 50);

    setInterval(() => {
        fetch('/api/stats/overview')
            .then(r => r.json())
            .then(updateStatistics)
            .catch(err => console.error('Error updating stats:', err));
    }, 30000);
});

/* ---------- Layout helpers ---------- */
function removeDuplicateCards() {
    const ids = ['welcome','total-controllers','online-controllers','offline-controllers','system-version','map','controller-list','quick-actions','system-status'];
    ids.forEach(id => {
        const els = document.querySelectorAll(`[data-card-id="${id}"].grid-item`);
        for (let i = 1; i < els.length; i++) els[i].remove();
    });
}

function toggleEditMode() {
    editMode = !editMode;
    const toggle = document.getElementById('editModeToggle');
    const text = document.getElementById('editModeText');
    const grid = document.getElementById('dashboardGrid');
    const panel = document.getElementById('cardManagementPanel');

    if (editMode) {
        toggle.classList.add('active'); text.textContent = 'Exit Edit';
        grid.classList.add('edit-mode'); panel.style.display = 'block';
        document.querySelectorAll('.grid-item').forEach(i => i.classList.add('edit-mode'));
        updateCardCheckboxes();
    } else {
        toggle.classList.remove('active'); text.textContent = 'Edit Layout';
        grid.classList.remove('edit-mode'); panel.style.display = 'none';
        document.querySelectorAll('.grid-item').forEach(i => i.classList.remove('edit-mode'));
    }
}

function toggleCard(cardId) {
    const cards = document.querySelectorAll(`[data-card-id="${cardId}"]`);
    const checkbox = document.getElementById(`card-${cardId}`);
    if (!checkbox) return;
    cards.forEach(card => {
        card.style.display = checkbox.checked ? '' : 'none';
        if (cardId === 'map' && checkbox.checked) setTimeout(resizeMap, 100);
    });
    saveLayoutToStorage();
}

function updateCardCheckboxes() {
    document.querySelectorAll('.grid-item').forEach(item => {
        const cb = document.getElementById(`card-${item.dataset.cardId}`);
        if (cb) cb.checked = item.style.display !== 'none';
    });
}

function closeCardManagement() { if (editMode) toggleEditMode(); }
function saveLayout() { saveLayoutToStorage(); flash('Layout saved successfully!', 'success'); }

function flash(message, type) {
    const el = document.createElement('div');
    el.className = `alert alert-${type} alert-dismissible fade show`;
    el.style.position = 'fixed'; el.style.top = '100px'; el.style.right = '20px';
    el.style.zIndex = '9999'; el.style.minWidth = '300px';
    el.innerHTML = `${message}<button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

function initializeDragAndDrop() {
    const items = document.querySelectorAll('.grid-item');
    items.forEach(item => {
        item.draggable = true;

        item.addEventListener('dragstart', e => {
            if (!editMode) { e.preventDefault(); return; }
            draggedElement = item;
            item.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', item.outerHTML);
        });

        item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
            draggedElement = null;
        });

        item.addEventListener('dragover', e => {
            if (!editMode || !draggedElement) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            item.classList.add('drag-over');
        });

        item.addEventListener('dragleave', () => item.classList.remove('drag-over'));

        item.addEventListener('drop', e => {
            if (!editMode || !draggedElement) return;
            e.preventDefault();
            item.classList.remove('drag-over');

            if (item !== draggedElement) {
                const parent = item.parentNode;
                const draggedNext = draggedElement.nextSibling;
                const thisNext = item.nextSibling;

                parent.insertBefore(draggedElement, thisNext);
                parent.insertBefore(item, draggedNext);

                saveLayoutToStorage();
                if (draggedElement.dataset.cardId === 'map' || item.dataset.cardId === 'map') {
                    setTimeout(initializeMap, 100);
                }
            }
        });

        const handle = item.querySelector('.resize-handle');
        if (handle) {
            handle.addEventListener('mousedown', e => {
                if (!editMode) return;
                e.preventDefault(); e.stopPropagation();
                const startX = e.clientX, startY = e.clientY, startRect = item.getBoundingClientRect();

                function onMove(e2) {
                    const dx = e2.clientX - startX, dy = e2.clientY - startY;
                    const gridSize = 100;
                    const newCols = Math.max(3, Math.round((startRect.width + dx) / (startRect.width / getCurrentCols(item))));
                    const newRows = Math.max(2, Math.round((startRect.height + dy) / gridSize));
                    item.style.gridColumn = `span ${Math.min(newCols, 12)}`;
                    item.style.gridRow = `span ${newRows}`;
                    if (item.dataset.cardId === 'map') debounceMapResize();
                }
                function onUp() {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    saveLayoutToStorage();
                    if (item.dataset.cardId === 'map') setTimeout(resizeMap, 100);
                }
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
        }
    });
}

function getCurrentCols(el) {
    const gc = window.getComputedStyle(el).gridColumn;
    const m = gc.match(/span (\d+)/);
    return m ? parseInt(m[1]) : 3;
}

let mapResizeTimeout;
function debounceMapResize() { clearTimeout(mapResizeTimeout); mapResizeTimeout = setTimeout(resizeMap, 100); }
function resizeMap() { if (olMap) olMap.updateSize(); }

function saveLayoutToStorage() {
    const layout = [];
    document.querySelectorAll('.grid-item').forEach((item, i) => {
        const style = window.getComputedStyle(item);
        layout.push({
            cardId: item.dataset.cardId,
            order: i,
            gridColumn: item.style.gridColumn || style.gridColumn,
            gridRow: item.style.gridRow || style.gridRow,
            visible: item.style.display !== 'none'
        });
    });
    localStorage.setItem('dashboardLayout', JSON.stringify(layout));
}

function loadLayoutFromStorage() {
    const saved = localStorage.getItem('dashboardLayout');
    if (!saved) return;
    try {
        const layout = JSON.parse(saved).sort((a,b)=>a.order-b.order);
        const grid = document.getElementById('dashboardGrid');
        const items = Array.from(document.querySelectorAll('.grid-item'));
        const map = new Map(items.map(el => [el.dataset.cardId, el]));
        layout.forEach(conf => {
            const el = map.get(conf.cardId);
            if (!el) return;
            el.remove();
            if (conf.gridColumn && conf.gridColumn !== 'auto') el.style.gridColumn = conf.gridColumn;
            if (conf.gridRow && conf.gridRow !== 'auto') el.style.gridRow = conf.gridRow;
            el.style.display = conf.visible ? '' : 'none';
            grid.appendChild(el);
        });
        if (editMode) updateCardCheckboxes();
        setTimeout(initializeMap, 200);
    } catch (e) {
        console.warn('Failed to load dashboard layout:', e);
        localStorage.removeItem('dashboardLayout');
    }
}

/* =================== MAP (OpenLayers) =================== */
function initializeMap() {
    const mapEl = document.getElementById('map');
    if (!mapEl) return;
    const mapCard = mapEl.closest('.grid-item');
    if (mapCard && mapCard.style.display === 'none') return;

    // Status overlay (create once)
    if (!mapStatusEl) {
        mapStatusEl = document.createElement('div');
        mapStatusEl.style.position = 'absolute';
        mapStatusEl.style.inset = '0';
        mapStatusEl.style.display = 'none';
        mapStatusEl.style.alignItems = 'center';
        mapStatusEl.style.justifyContent = 'center';
        mapStatusEl.style.pointerEvents = 'none';
        mapStatusEl.innerHTML = `
          <div style="background:rgba(255,255,255,.92); border:1px solid #e5e7eb; padding:12px 14px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.08); font-size:14px; color:#444;">
            <i class="fas fa-info-circle"></i> <span id="mapStatusMsg">Loading map…</span>
          </div>`;
        mapEl.appendChild(mapStatusEl);
    }

    if (!olMap) {
        const center = ol.proj.fromLonLat([4.9041, 52.3676]); // Amsterdam
        vectorSource = new ol.source.Vector();
        vectorLayer  = new ol.layer.Vector({
            source: vectorSource,
            style: defaultFeatureStyle
        });

        olMap = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({ source: new ol.source.OSM() }),
                vectorLayer
            ],
            view: new ol.View({ center, zoom: 8 })
        });

        // Popup overlay
        const popup = document.createElement('div');
        popup.className = 'ol-popup';
        popupOverlay = new ol.Overlay({ element: popup, offset: [0, -10], positioning: 'bottom-center', stopEvent: true });
        olMap.addOverlay(popupOverlay);

        // Click to show popup
        olMap.on('singleclick', function (evt) {
            const feature = olMap.forEachFeatureAtPixel(evt.pixel, f => f);
            if (feature) {
                const c = feature.get('controller');
                popup.innerHTML = buildPopupHtml(c);
                popupOverlay.setPosition(evt.coordinate);
            } else {
                popupOverlay.setPosition(undefined);
            }
        });
    }

    setMapStatus('Loading data…', 'info');
    
    // Load marker configuration
    loadDashboardMarkerConfig();
    
    refreshMapData(true);
    startMapAutoRefresh();
    setTimeout(() => olMap && olMap.updateSize(), 100);
}

/* ---- Marker Configuration ---- */
let dashboardMarkerConfig = null;

async function loadDashboardMarkerConfig() {
    try {
        const response = await fetch('/admin/api/marker-config');
        if (response.ok) {
            dashboardMarkerConfig = await response.json();
            console.log('Dashboard marker configuration loaded:', dashboardMarkerConfig);
        } else {
            console.warn('Failed to load marker configuration, using defaults');
            dashboardMarkerConfig = getDefaultDashboardMarkerConfig();
        }
    } catch (error) {
        console.warn('Error loading marker configuration:', error);
        dashboardMarkerConfig = getDefaultDashboardMarkerConfig();
    }
}

function getDefaultDashboardMarkerConfig() {
    return {
        speedradar: { online: { color: '#17a2b8' }, offline: { color: '#dc3545' } },
        beaufortmeter: { online: { color: '#28a745' }, offline: { color: '#dc3545' } },
        weatherstation: { online: { color: '#ffc107' }, offline: { color: '#dc3545' } },
        aicamera: { online: { color: '#dc3545' }, offline: { color: '#6c757d' } },
        default: { online: { color: '#6c757d' }, offline: { color: '#dc3545' } }
    };
}

function darkenColor(color, factor) {
    // Simple color darkening function for hex colors
    if (color.startsWith('#')) {
        const hex = color.slice(1);
        const r = Math.floor(parseInt(hex.substr(0, 2), 16) * (1 - factor));
        const g = Math.floor(parseInt(hex.substr(2, 2), 16) * (1 - factor));
        const b = Math.floor(parseInt(hex.substr(4, 2), 16) * (1 - factor));
        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
    }
    return color;
}

/* ---- Map marker style: maps-like pin (green/red) ---- */
function getIconStyleForController(c) {
  // Ensure marker config is loaded
  if (!dashboardMarkerConfig) {
    dashboardMarkerConfig = getDefaultDashboardMarkerConfig();
  }
  
  const online = !!c?.is_online;
  const controllerType = (c?.type || c?.controller_type || 'default').toLowerCase();
  const state = online ? 'online' : 'offline';
  
  // Get color configuration for this controller type and state
  const typeConfig = dashboardMarkerConfig[controllerType] || dashboardMarkerConfig.default;
  const stateConfig = typeConfig[state];
  const fill = stateConfig.color || (online ? '#28a745' : '#dc3545');
  
  // Calculate stroke color (darker version of fill)
  const stroke = darkenColor(fill, 0.3);
  const dot = '#ffffff';                        // inner dot

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
    <!-- drop shadow -->
    <ellipse cx="24" cy="44" rx="8" ry="3" fill="rgba(0,0,0,0.25)"/>
    <!-- pin -->
    <g transform="translate(0,0)">
      <path d="M24 4
               C14 4 6 12 6 22
               c0 9.5 9.2 17.7 16.3 23.9
               a2.5 2.5 0 0 0 3.4 0C32.8 39.7 42 31.5 42 22
               C42 12 34 4 24 4z"
            fill="${fill}" stroke="${stroke}" stroke-width="2"/>
      <circle cx="24" cy="22" r="7" fill="${dot}" />
    </g>
  </svg>`.trim();

  const url = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);

  return new ol.style.Style({
    image: new ol.style.Icon({
      src: url,
      anchor: [0.5, 1],           // bottom tip sits on the coordinate
      anchorXUnits: 'fraction',
      anchorYUnits: 'fraction'
    })
  });
}

function defaultFeatureStyle(feature) {
  const c = feature.get('controller') || {};
  return getIconStyleForController(c);
}

function startMapAutoRefresh() {
    if (window.__olRefreshTimer) return;
    window.__olRefreshTimer = setInterval(() => refreshMapData(false), REFRESH_MS);
}

function setMapStatus(msg, type) {
    if (!mapStatusEl) return;
    mapStatusEl.style.display = 'flex';
    const span = mapStatusEl.querySelector('#mapStatusMsg');
    if (span) span.textContent = msg;
    const icon = mapStatusEl.querySelector('i');
    if (icon) {
        icon.className = type === 'error' ? 'fas fa-exclamation-triangle'
                       : type === 'empty' ? 'fas fa-map-marker-alt'
                       : 'fas fa-info-circle';
    }
    const box = mapStatusEl.firstElementChild;
    if (box) {
        box.style.borderColor = type === 'error' ? '#f5c2c7' : type === 'empty' ? '#cfe2ff' : '#e5e7eb';
        box.style.background = type === 'error' ? 'rgba(255,245,245,.95)'
                             : type === 'empty' ? 'rgba(248,249,255,.95)'
                             : 'rgba(255,255,255,.92)';
    }
}
function clearMapStatus() { if (mapStatusEl) mapStatusEl.style.display = 'none'; }

function refreshMapData(fitOnFirstLoad = false) {
    fetch('/api/map-data', {
        method: 'GET',
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
    })
    .then(async res => {
        const text = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} — ${text.slice(0,180)}`);
        try { return JSON.parse(text); }
        catch(e){ console.error('[map] Non-JSON body:', text.slice(0,200)); throw new Error(`Invalid JSON: ${e.message}`); }
    })
    .then(payload => {
        const data = unwrapArray(payload);
        if (!Array.isArray(data)) throw new Error('Expected array from /api/map-data');

        const seen = new Set();
        let added = 0, updated = 0, removed = 0, skipped = 0;

        data.forEach(item => {
            const id  = item.id ?? item.controller_id ?? item.serial_number ?? item.name;
            const lat = toNum(item.latitude);
            const lng = toNum(item.longitude);
            if (!id || !isFinite(lat) || !isFinite(lng)) { skipped++; return; }

            seen.add(String(id));
            const key = String(id);
            const coord3857 = ol.proj.fromLonLat([lng, lat]);

            if (featuresById[key]) {
                featuresById[key].setGeometry(new ol.geom.Point(coord3857));
                featuresById[key].set('controller', item);
                updated++;
            } else {
                const feat = new ol.Feature({ geometry: new ol.geom.Point(coord3857), controller: item });
                feat.setStyle(defaultFeatureStyle(feat));
                vectorSource.addFeature(feat);
                featuresById[key] = feat;
                added++;
            }
        });

        // remove vanished
        Object.keys(featuresById).forEach(key => {
            if (!seen.has(key)) {
                vectorSource.removeFeature(featuresById[key]);
                delete featuresById[key];
                removed++;
            }
        });

        // Fit once
        if (fitOnFirstLoad) {
            const feats = vectorSource.getFeatures();
            if (feats.length > 0) {
                const extent = vectorSource.getExtent();
                if (extent && isFinite(extent[0])) {
                    olMap.getView().fit(extent, { padding: [40, 40, 40, 40], duration: 300, maxZoom: 15 });
                    clearMapStatus();
                }
            } else {
                setMapStatus('No controllers with location data', 'empty');
            }
        } else {
            if (vectorSource.getFeatures().length > 0) clearMapStatus();
            else setMapStatus('No controllers with location data', 'empty');
        }

        console.log('[map] added:', added, 'updated:', updated, 'removed:', removed, 'skipped:', skipped);
    })
    .catch(err => {
        console.error('[map] Error loading map data:', err);
        setMapStatus('Error loading data', 'error');
    });
}

function buildPopupHtml(c) {
    const name = c.name || c.serial_number || 'Unnamed';
    const type = (c.type || c.controller_type || 'default') + '';
    const capType = type.charAt(0).toUpperCase() + type.slice(1);
    const online = !!c.is_online;
    const statusColor = online ? '#28a745' : '#dc3545';
    const lastSeen = c.last_seen ? new Date(c.last_seen).toLocaleString() : null;
    const id = c.id ?? c.controller_id ?? '';

    return `
        <div class="marker-popup">
            <h6 style="margin:0 0 8px 0; color:#333; font-weight:600;">${escapeHtml(name)}</h6>
            <p style="margin:0 0 4px 0; display:flex; align-items:center;">
                <span style="display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;background:${statusColor};"></span>
                <span style="font-size:13px;color:${statusColor};font-weight:500;">${online ? 'Online' : 'Offline'}</span>
            </p>
            <p style="margin:0 0 4px 0; font-size:13px; color:#666;"><strong>Type:</strong> ${escapeHtml(capType)}</p>
            ${c.serial_number ? `<p style="margin:0 0 4px 0; font-size:13px; color:#666;"><strong>Serial:</strong> ${escapeHtml(c.serial_number)}</p>` : ''}
            ${lastSeen ? `<p style="margin:0 0 8px 0; font-size:12px; color:#888;"><strong>Last Seen:</strong> ${escapeHtml(lastSeen)}</p>` : ''}
            <div class="text-center" style="margin-top:10px;">
                ${id ? `<a href="/controllers/${id}/data" class="btn btn-sm btn-primary" style="margin-right:4px;padding:4px 8px;font-size:12px;"><i class="fas fa-chart-line"></i> View Data</a>` : ''}
                ${id ? `<a href="/controllers/${id}/edit" class="btn btn-sm btn-outline-secondary" style="padding:4px 8px;font-size:12px;"><i class="fas fa-edit"></i> Edit</a>` : ''}
            </div>
        </div>
    `;
}

/* -------- helpers -------- */
function unwrapArray(payload) {
    if (Array.isArray(payload)) return payload;
    const cands = [payload?.data, payload?.items, payload?.controllers, payload?.results?.items, payload?.result?.items, payload?.payload];
    for (const c of cands) if (Array.isArray(c)) return c;
    return null;
}
function toNum(v) { if (v == null) return NaN; if (typeof v === 'string') v = v.trim().replace(',', '.'); return parseFloat(v); }
function escapeHtml(v) {
    return String(v).replace(/[&<>"'`=\/]/g, s => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;',
        "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
    }[s]));
}

/* === stats === */
function updateStatistics(data) {
    if (data.total_controllers !== undefined) {
        const totalCard = document.querySelector('[data-card-id="total-controllers"] .stat-value');
        if (totalCard) totalCard.textContent = data.total_controllers;
    }
    if (data.online_controllers !== undefined) {
        const onlineCard = document.querySelector('[data-card-id="online-controllers"] .stat-value');
        if (onlineCard) onlineCard.textContent = data.online_controllers;
        const offlineCard = document.querySelector('[data-card-id="offline-controllers"] .stat-value');
        if (offlineCard) offlineCard.textContent = data.total_controllers - data.online_controllers;
    }
}

/* === reset / shortcuts === */
function resetLayout() { localStorage.removeItem('dashboardLayout'); location.reload(); }
document.addEventListener('keydown', function (e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') { e.preventDefault(); toggleEditMode(); }
    if (e.key === 'Escape' && editMode) toggleEditMode();
});
</script>
{% endblock %}
