{% extends "base.html" %}

{% block title %}{{ controller.name }} Data - LXCloud{% endblock %}

{% block extra_css %}
<style>
/* ===== Modern UI - Lovable-inspired styles ===== */
.page-container {
    min-height: 100vh;
    background: hsl(var(--background, 0 0% 100%));
}

/* CSS Variables for Lovable-like design system */
:root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --primary: 222.2 47.4% 11.2%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96%;
    --secondary-foreground: 222.2 84% 4.9%;
    --muted: 210 40% 96%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 210 40% 96%;
    --accent-foreground: 222.2 84% 4.9%;
    --destructive: 0 72.2% 50.6%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 222.2 84% 4.9%;
    --radius: 0.5rem;
}

/* Status Pill Component */
.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 9999px;
    padding: 0.25rem 0.625rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-pill.neutral {
    background-color: hsl(var(--muted));
    color: hsl(var(--muted-foreground));
}

.status-pill.accent {
    background-color: hsl(var(--accent));
    color: hsl(var(--accent-foreground));
}

.status-pill.success {
    background-color: hsl(120 57% 95%);
    color: hsl(120 57% 25%);
}

.status-pill.danger {
    background-color: hsl(var(--destructive) / 0.1);
    color: hsl(var(--destructive));
}

.status-pill-dot {
    height: 0.375rem;
    width: 0.375rem;
    border-radius: 50%;
}

.status-pill.neutral .status-pill-dot {
    background-color: hsl(var(--foreground) / 0.5);
}

.status-pill.accent .status-pill-dot {
    background-color: hsl(var(--foreground) / 0.7);
}

.status-pill.success .status-pill-dot {
    background-color: hsl(120 57% 45%);
}

.status-pill.danger .status-pill-dot {
    background-color: hsl(var(--destructive));
}

/* Modern Cards */
.modern-card {
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: calc(var(--radius) + 2px);
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    padding: 1rem;
}

/* Stats Cards */
.stats-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    margin-bottom: 1.5rem;
}

.stat-card {
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: calc(var(--radius) + 2px);
    padding: 1rem;
    text-align: center;
}

.stat-card .stat-label {
    font-size: 0.875rem;
    color: hsl(var(--muted-foreground));
    margin-bottom: 0.5rem;
}

.stat-card .stat-value {
    font-size: 1.5rem;
    font-weight: 500;
    margin: 0;
}

/* Table Styles */
.modern-table {
    width: 100%;
    border-collapse: collapse;
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: calc(var(--radius) + 2px);
    overflow: hidden;
}

.modern-table th {
    background: hsl(var(--muted) / 0.5);
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 500;
    color: hsl(var(--foreground));
    border-bottom: 1px solid hsl(var(--border));
}

.modern-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid hsl(var(--border));
}

.modern-table tr:last-child td {
    border-bottom: none;
}

.modern-table tr:hover {
    background: hsl(var(--muted) / 0.3);
}

/* Buttons */
.btn-modern {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    border-radius: calc(var(--radius));
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    text-decoration: none;
}

.btn-modern.btn-primary {
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
}

.btn-modern.btn-primary:hover {
    background: hsl(var(--primary) / 0.9);
    color: hsl(var(--primary-foreground));
    text-decoration: none;
}

.btn-modern.btn-outline {
    border: 1px solid hsl(var(--border));
    background: transparent;
    color: hsl(var(--foreground));
}

.btn-modern.btn-outline:hover {
    background: hsl(var(--accent));
    color: hsl(var(--accent-foreground));
    text-decoration: none;
}

.btn-modern.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
}

/* Header */
.page-header-modern {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.page-header-modern h1 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.875rem;
    font-weight: 600;
    letter-spacing: -0.025em;
    margin: 0;
}

.page-header-modern p {
    font-size: 0.875rem;
    color: hsl(var(--muted-foreground));
    margin: 0.25rem 0 0 0;
}

/* Data specific styles */
.data-table {
    max-height: 600px;
    overflow-y: auto;
    border-radius: calc(var(--radius) + 2px);
    border: 1px solid hsl(var(--border));
}

.json-data {
    background-color: hsl(var(--muted));
    border: 1px solid hsl(var(--border));
    border-radius: calc(var(--radius));
    padding: 8px;
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 0.8em;
    white-space: pre-wrap;
    color: hsl(var(--foreground));
    overflow-x: auto;
}

.refresh-indicator {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1000;
}

/* Controller icon styling */
.controller-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    border-radius: calc(var(--radius) + 2px);
    background: hsl(var(--accent));
    color: hsl(var(--accent-foreground));
    font-size: 1.25rem;
}

/* Modal Styles */
.modal-modern .modal-content {
    border-radius: calc(var(--radius) + 4px);
    border: 1px solid hsl(var(--border));
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
}

.modal-modern .modal-header {
    border-bottom: 1px solid hsl(var(--border));
    padding: 1rem 1.5rem;
}

.modal-modern .modal-body {
    padding: 1.5rem;
}

.modal-modern .modal-footer {
    border-top: 1px solid hsl(var(--border));
    padding: 1rem 1.5rem;
}

/* Form Controls */
.form-control-modern {
    border: 1px solid hsl(var(--border));
    border-radius: calc(var(--radius));
    padding: 0.5rem 0.75rem;
    background: hsl(var(--background));
    color: hsl(var(--foreground));
}

.form-control-modern:focus {
    outline: none;
    border-color: hsl(var(--ring));
    box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
}

/* Empty State */
.empty-state-modern {
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: calc(var(--radius) + 2px);
    padding: 2.5rem 1rem;
    text-align: center;
}

.empty-state-modern .icon {
    margin: 0 auto 0.75rem auto;
    height: 2.5rem;
    width: 2.5rem;
    color: hsl(var(--muted-foreground));
}

.empty-state-modern h5 {
    font-size: 1.125rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.empty-state-modern p {
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: hsl(var(--muted-foreground));
}

/* Responsive */
@media (min-width: 640px) {
    .page-header-modern {
        flex-direction: row;
        align-items: end;
        justify-content: space-between;
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

/* Utilities */
.container {
    width: 100%;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
}

.mx-auto {
    margin-left: auto;
    margin-right: auto;
}

.py-10 {
    padding-top: 2.5rem;
    padding-bottom: 2.5rem;
}

.mb-6 {
    margin-bottom: 1.5rem;
}

.gap-2 {
    gap: 0.5rem;
}

.d-flex {
    display: flex;
}

.d-inline-flex {
    display: inline-flex;
}

.justify-content-between {
    justify-content: space-between;
}

.justify-content-end {
    justify-content: flex-end;
}

.align-items-center {
    align-items: center;
}

.text-muted {
    color: hsl(var(--muted-foreground));
}

.font-medium {
    font-weight: 500;
}

.text-lg {
    font-size: 1.125rem;
    line-height: 1.75rem;
}

.text-sm {
    font-size: 0.875rem;
    line-height: 1.25rem;
}

.font-mono {
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
}

.overflow-auto {
    overflow: auto;
}

.separator {
    height: 1px;
    background: hsl(var(--border));
    margin: 1rem 0;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}
</style>
{% endblock %}

{% block content %}
<main class="page-container">
    <section class="container mx-auto py-10">
        <!-- Header -->
        <header class="page-header-modern">
            <div class="d-flex align-items-center gap-2">
                <div class="controller-icon">
                    {% if controller.controller_type == 'speedradar' %}
                        <i class="fas fa-tachometer-alt"></i>
                    {% elif controller.controller_type == 'beaufortmeter' %}
                        <i class="fas fa-wind"></i>
                    {% elif controller.controller_type == 'weatherstation' %}
                        <i class="fas fa-cloud-sun"></i>
                    {% elif controller.controller_type == 'aicamera' %}
                        <i class="fas fa-camera"></i>
                    {% else %}
                        <i class="fas fa-microchip"></i>
                    {% endif %}
                </div>
                <div>
                    <h1>{{ controller.name or controller.serial_number }}</h1>
                    <p class="text-muted">
                        {{ controller.controller_type.title() }} â€¢ {{ controller.serial_number }}
                        {% if controller.is_online %}
                            <span class="status-pill success">
                                <span class="status-pill-dot"></span>
                                Online
                            </span>
                        {% else %}
                            <span class="status-pill danger">
                                <span class="status-pill-dot"></span>
                                Offline
                            </span>
                        {% endif %}
                    </p>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('controllers.edit_controller', controller_id=controller.id) }}" 
                   class="btn-modern btn-outline">
                    <i class="fas fa-edit"></i> Edit
                </a>
                <button class="btn-modern btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i> Refresh
                </button>
                <a href="{{ url_for('controllers.index') }}" class="btn-modern btn-outline">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <p class="stat-label">Total Records</p>
                <p class="stat-value" id="total-records">{{ data_points|length }}</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Last Update</p>
                <p class="stat-value" id="last-update">
                    {% if data_points %}
                        {{ data_points[0].timestamp.strftime('%H:%M:%S') }}
                    {% else %}
                        No data
                    {% endif %}
                </p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Data Rate</p>
                <p class="stat-value" id="data-rate">-</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Avg Interval</p>
                <p class="stat-value" id="avg-interval">-</p>
            </div>
        </div>

        <!-- Data Table Section -->
        <section class="mb-6">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-lg font-medium">Recent Data Points</h2>
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" id="autoRefresh" checked>
                    <label for="autoRefresh" class="text-sm">Auto Refresh</label>
                </div>
            </div>
            <div class="separator"></div>
            
            {% if data_points %}
                <div class="data-table">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Data</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                            {% for data_point in data_points %}
                            <tr>
                                <td>
                                    <div class="font-medium">{{ data_point.timestamp.strftime('%H:%M:%S') }}</div>
                                    <div class="text-muted text-sm">{{ data_point.timestamp.strftime('%Y-%m-%d') }}</div>
                                </td>
                                <td>
                                    <div class="json-data">{{ data_point.get_data_dict() | tojson(indent=2) }}</div>
                                </td>
                                <td style="text-align: right;">
                                    <button class="btn-modern btn-outline btn-sm" 
                                            onclick="viewDataDetails({{ data_point.get_data_dict() | tojson | safe }}, '{{ data_point.timestamp.isoformat() }}')">
                                        <i class="fas fa-eye"></i>
                                        <span class="sr-only">View details</span>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state-modern">
                    <i class="fas fa-chart-line icon" aria-hidden="true"></i>
                    <h5>No Data Available</h5>
                    <p>This controller hasn't sent any data yet.</p>
                </div>
            {% endif %}
        </section>
    </section>
</main>

<!-- Data Details Modal -->
<div class="modal fade modal-modern" id="dataDetailsModal" tabindex="-1" aria-labelledby="dataDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dataDetailsModalLabel">Data Point Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label font-medium">Timestamp:</label>
                    <div id="modal-timestamp" class="text-muted"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label font-medium">Raw Data:</label>
                    <pre id="modal-data" class="json-data"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modern btn-outline" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Refresh Indicator -->
<div class="refresh-indicator" id="refresh-indicator" style="display: none;">
    <div class="modern-card">
        <div class="d-flex align-items-center gap-2 text-sm">
            <i class="fas fa-sync-alt fa-spin"></i> Refreshing data...
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let autoRefreshInterval;
let lastRefreshTime = new Date();

// Custom Modal Implementation for Bootstrap Modal functionality
class SimpleModal {
    constructor(element) {
        this.element = element;
        this.backdrop = null;
        this.isVisible = false;
    }
    
    show() {
        if (this.isVisible) return;
        
        // Create backdrop
        this.backdrop = document.createElement('div');
        this.backdrop.className = 'modal-backdrop fade show';
        this.backdrop.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1050 !important;
            width: 100vw !important;
            height: 100vh !important;
            background-color: rgba(0, 0, 0, 0.5) !important;
        `;
        
        // Show modal
        document.body.appendChild(this.backdrop);
        document.body.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
        
        // Show the modal element
        this.element.style.display = 'block';
        this.element.classList.add('show');
        this.element.style.cssText += `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1055 !important;
            width: 100% !important;
            height: 100% !important;
            overflow-x: hidden;
            overflow-y: auto;
            outline: 0;
        `;
        
        this.isVisible = true;
        
        // Focus on first input
        const firstInput = this.element.querySelector('input, textarea, select');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
        
        // Handle backdrop clicks
        this.backdrop.addEventListener('click', () => this.hide());
        
        // Handle escape key
        this.escapeHandler = (e) => {
            if (e.key === 'Escape') this.hide();
        };
        document.addEventListener('keydown', this.escapeHandler);
    }
    
    hide() {
        if (!this.isVisible) return;
        
        // Hide modal
        this.element.classList.remove('show');
        this.element.style.display = 'none';
        this.element.style.cssText = '';
        
        // Remove backdrop
        if (this.backdrop) {
            document.body.removeChild(this.backdrop);
            this.backdrop = null;
        }
        
        // Restore body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        
        this.isVisible = false;
        
        // Remove escape handler
        if (this.escapeHandler) {
            document.removeEventListener('keydown', this.escapeHandler);
            this.escapeHandler = null;
        }
    }
}

// Initialize on document ready
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
    calculateDataStats();
    
    // Initialize modal
    const dataModalEl = document.getElementById('dataDetailsModal');
    let dataModal = null;
    
    if (dataModalEl) {
        dataModal = new SimpleModal(dataModalEl);
        window.dataModal = dataModal; // Make it globally accessible
        
        // Handle close buttons
        const closeButtons = dataModalEl.querySelectorAll('[data-bs-dismiss="modal"]');
        closeButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                dataModal.hide();
            });
        });
    }

    // Add hover effects to table rows
    const tableRows = document.querySelectorAll('.modern-table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-1px)';
            this.style.transition = 'transform 0.2s ease';
        });
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});

function startAutoRefresh() {
    if (document.getElementById('autoRefresh').checked) {
        autoRefreshInterval = setInterval(refreshData, 30000); // 30 seconds
    }
}

function toggleAutoRefresh() {
    if (document.getElementById('autoRefresh').checked) {
        startAutoRefresh();
    } else {
        clearInterval(autoRefreshInterval);
    }
}

document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);

function refreshData() {
    const refreshIcon = document.getElementById('refresh-icon');
    const indicator = document.getElementById('refresh-indicator');
    
    refreshIcon.classList.add('fa-spin');
    indicator.style.display = 'block';
    
    fetch(`/api/controllers/{{ controller.id }}/recent-data?limit=100`)
        .then(response => response.json())
        .then(data => {
            updateDataTable(data);
            updateDataStats(data);
            lastRefreshTime = new Date();
        })
        .catch(error => {
            console.error('Error refreshing data:', error);
            // Simple alert instead of LXCloud.showAlert
            alert('Error refreshing data: ' + error.message);
        })
        .finally(() => {
            refreshIcon.classList.remove('fa-spin');
            indicator.style.display = 'none';
        });
}

function updateDataTable(dataPoints) {
    const tbody = document.getElementById('data-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (dataPoints.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center py-4">
                    <i class="fas fa-chart-line fa-2x text-muted mb-2"></i><br>
                    <span class="text-muted">No data available</span>
                </td>
            </tr>
        `;
        return;
    }
    
    dataPoints.forEach(dataPoint => {
        const timestamp = new Date(dataPoint.timestamp);
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>
                <div class="font-medium">${timestamp.toLocaleTimeString()}</div>
                <div class="text-muted text-sm">${timestamp.toLocaleDateString()}</div>
            </td>
            <td>
                <div class="json-data">${JSON.stringify(dataPoint.data, null, 2)}</div>
            </td>
            <td style="text-align: right;">
                <button class="btn-modern btn-outline btn-sm" 
                        onclick="viewDataDetails(${JSON.stringify(dataPoint.data).replace(/"/g, '&quot;')}, '${dataPoint.timestamp}')">
                    <i class="fas fa-eye"></i>
                    <span class="sr-only">View details</span>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        
        // Add hover effect to new row
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-1px)';
            this.style.transition = 'transform 0.2s ease';
        });
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
}

function updateDataStats(dataPoints) {
    document.getElementById('total-records').textContent = dataPoints.length;
    
    if (dataPoints.length > 0) {
        const lastUpdate = new Date(dataPoints[0].timestamp);
        document.getElementById('last-update').textContent = lastUpdate.toLocaleTimeString();
        
        // Calculate data rate (points per hour)
        if (dataPoints.length > 1) {
            const firstTime = new Date(dataPoints[dataPoints.length - 1].timestamp);
            const lastTime = new Date(dataPoints[0].timestamp);
            const hoursDiff = (lastTime - firstTime) / (1000 * 60 * 60);
            const rate = hoursDiff > 0 ? Math.round(dataPoints.length / hoursDiff) : 0;
            document.getElementById('data-rate').textContent = `${rate}/hour`;
            
            // Calculate average interval
            const totalIntervals = dataPoints.length - 1;
            const avgInterval = hoursDiff > 0 ? Math.round((hoursDiff * 60) / totalIntervals) : 0;
            document.getElementById('avg-interval').textContent = `${avgInterval}min`;
        }
    }
}

function calculateDataStats() {
    const rows = document.querySelectorAll('#data-table-body tr');
    if (rows.length > 1) {
        // Calculate stats from existing table data
        const timestamps = [];
        rows.forEach(row => {
            const timeCell = row.querySelector('td:first-child .font-medium');
            if (timeCell) {
                const timeText = timeCell.textContent;
                const dateText = row.querySelector('td:first-child .text-muted').textContent;
                timestamps.push(new Date(`${dateText} ${timeText}`));
            }
        });
        
        if (timestamps.length > 1) {
            const totalTime = timestamps[0] - timestamps[timestamps.length - 1];
            const hours = totalTime / (1000 * 60 * 60);
            const rate = hours > 0 ? Math.round(timestamps.length / hours) : 0;
            const avgInterval = hours > 0 ? Math.round((hours * 60) / (timestamps.length - 1)) : 0;
            
            document.getElementById('data-rate').textContent = `${rate}/hour`;
            document.getElementById('avg-interval').textContent = `${avgInterval}min`;
        }
    }
}

function viewDataDetails(data, timestamp) {
    if (window.dataModal) {
        document.getElementById('modal-timestamp').textContent = new Date(timestamp).toLocaleString();
        document.getElementById('modal-data').textContent = JSON.stringify(data, null, 2);
        window.dataModal.show();
    }
}
</script>
{% endblock %}